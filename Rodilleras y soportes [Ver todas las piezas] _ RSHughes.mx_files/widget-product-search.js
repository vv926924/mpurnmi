$.widget("rsh.productSearch",{options:{animate:!0},_create:function(){},_init:function(){this.widgetID=this.element.attr("data-widget-id")||"";this.filtersElement=$('.widget-product-search-summary[data-widget-id="'+this.widgetID+'"]').first();this._veil=this.filtersElement.find(".x-veil");this._pcont=this.element.find(".x-products");if(this.filtersElement.length){var a=this.element.attr("data-filter-mode");this._filterBrowser="browser"==a;this._filterHybrid="hybrid"==a;(this._filterBrowser||this._filterHybrid)&&
this._filterInit()}this._on(this.element,{"change .x-sort-selector select":this._setSort,"click .x-set-grouped":this._setViewGrouped,"click .x-set-individual":this._setViewIndividual,"click .x-set-grid":this._setViewGrid,"click .x-set-list":this._setViewList,"click .x-add":this._addToCart,"click .x-show-specs":this._showSpecs});this._on(this.filtersElement,{"click a.x-reset":this._filterClick,"click a.x-facet-clear":this._filterClick,"click a.x-filter-link":this._filterClick,"click .x-narrow-top":this._expandFilters,
"click .x-facet-title":this._expandFilter,"filtershow .x-facet-title":this._expandFilter,"filterhide .x-facet-title":this._expandFilter});this._fillPostLoad()},_fillPostLoad:function(){var a=this.element.find(".x-product[data-postload][data-product-id]");if(0!=a.length){var b=[];a.each(function(){b.push($(this).attr("data-product-id"))});rshJSON("/api/product-info.json",{format:"widget-product-search",product_ids:b.join(","),display_unit_name:this.element.attr("data-display-unit-name")},$.proxy(function(b){a.each(function(){var a=
$(this).attr("data-product-id");(a=b.html[a])&&$(this).replaceWith(a)});itemDraggableSetup(this.element.find(".item-draggable"));this.element.trigger("filterchange")},this),"POST")}},_setViewGrouped:function(a){a.preventDefault();a=urlParams();"pg_mode"in a&&delete a.pg_mode;a.v=$(".x-set-grid").hasClass("x-active")?"grid":"list";location.search=$.param(a)},_setViewIndividual:function(a){a.preventDefault();a=urlParams();a.pg_mode=0;a.v=$(".x-set-grid").hasClass("x-active")?"grid":"list";location.search=
$.param(a)},_setViewGrid:function(a){a.preventDefault();this._pcont.removeClass("x-view-list").addClass("x-view-grid");this.element.find(".x-set-list").removeClass("x-active");this.element.find(".x-set-grid").addClass("x-active");this._setPageNavParam("v","grid")},_setViewList:function(a){a.preventDefault();this._pcont.addClass("x-view-list").removeClass("x-view-grid");this.element.find(".x-set-list").addClass("x-active");this.element.find(".x-set-grid").removeClass("x-active");this._setPageNavParam("v",
"list")},_setSort:function(a){a.preventDefault();var b=urlParams();b.sort=$(a.target).val();b.v=this.element.find(".x-set-grid").hasClass("x-active")?"grid":"list";this._veil.fadeIn(100);location.search=$.param(b)},_setPageNavParam:function(a,b){var c=this.filtersElement.find("a"),c=c.add(this.element.find("a.x-nav-element"));c.each(function(){var c=$(this),g=urlParams(c[0].search);g[a]=b;c[0].search=$.param(g)})},_addToCart:function(a){a.preventDefault();$(a.target).closest("form").orderAdd().orderAdd("submit")},
_showSpecs:function(a){function b(){$(".spec-dialog .x-extras input.x-add").on("click",function(a){a.preventDefault();$(a.target).closest("form").orderAdd().orderAdd("submit")})}function c(){$(".spec-dialog .x-spec-name div").removeClass("x-name");var a=0;$(".spec-dialog tr").each(function(b){$(this).has(".x-spec-group").text()&&(a=0);$(this).has(".x-spec-name").text()&&a++;0!==a%2?($(this).css("background-color","#f0f0f0"),$(this).find(".x-spec-name").css({"background-color":"#f0f0f0"}),$(this).find(".x-spec-value").css({"padding-top":"3px",
"padding-bottom":"3px"})):0===a%2&&$(this).find(".x-spec-value").css({"padding-top":"5px","padding-bottom":"5px"})});$(".table-specs .x-item-spec").each(function(a){a=$(this);var b=0;a.children().each(function(){var a=$(this).outerHeight();a>b&&(b=a)});a.css({height:b+"px"});a.find(".x-spec-name").css({height:a.height()+"px"})});$(".spec-dialog .x-spec-name div").addClass("x-name")}function d(){var a=[],b={},c=[];$(".spec-dialog form").each(function(a){a=$(this).attr("data-product-id");-1===c.indexOf(a)&&
c.push(a)});for(var d=0;d<c.length;d++)$('form .x-wrapper-image[data-product-id="'+c[d]+'"]').next().next().next().find("li").each(function(a){a=$(this).find(".x-spec-value").text();var t=$(this).find(".x-spec-name").text();b[t]=a;b.id=c[d]}),a.push(b),b={};return a}function g(a){for(var b={same:[],similar:[],unique:[]},c=0;c<a.length;c++)for(var d in a[c])if("id"!=d&&"Trade Name"!=d){for(var f=0,g=0,l=!1,e=0;e<a.length;e++)a[e].hasOwnProperty(d)&&g++,c!==e&&a[c][d]===a[e][d]?(l=!0,f++,f===a.length-
1&&-1===b.same.indexOf(d)&&b.same.push(d)):c!==e&&a[c][d]!==a[e][d]&&(l=!1);!1===l&&-1===b.unique.indexOf(d)&&1===g&&b.unique.push(d);-1===b.same.indexOf(d)&&-1===b.unique.indexOf(d)&&-1===b.similar.indexOf(d)&&b.similar.push(d)}return b}function h(){for(var a=$(".spec-dialog form").attr("data-product-id"),b="",c=0;c<k.length;c++)for(var d in k[c])"id"!=d&&"Trade Name"!=d&&k[c].id===a&&(b+='<tr class="x-item-spec"><th class="x-spec-name static"><div>'+d+'</div></th><th class="x-spec-value">'+k[c][d]+
"</th></tr>");return b}function e(){$(".x-item-spec").remove();var a=g(k),b={same:"Id\u00e9ntico",similar:"Similar",unique:"\u00danico"},c;for(c in a){var d=$(".spec-dialog tbody"),f='<tr class="x-item-spec"><th class="x-spec-group static"><h3>'+b[c]+":</h3></th></tr>";if(0!==a[c].length){for(var e=0;e<a[c].length;e++){for(var f=f+('<tr class="x-item-spec"><th class="x-spec-name static"><div>'+a[c][e]+"</div></th>"),l=0;l<k.length;l++)if(a[c][e]in k[l])for(var m in k[l])a[c][e]===m&&(f="similar"===
c?f+('<th class="x-spec-value"><span>'+k[l][m]+"</span></th>"):f+('<th class="x-spec-value">'+k[l][m]+"</th>"));else"similar"!==c||a[c][e]in k[l]?"unique"!==c||a[c][e]in k[l]||(f+='<th class="x-spec-value"></th>'):f+='<th class="x-spec-value x-dash">\u2013 \u2013</th>';f+="</tr>"}d.append(f)}}if(0!==a.similar.length){var h={};2===$(".spec-dialog form").length?$(".spec-dialog .x-spec-value span").addClass("x-lowest"):2<$(".spec-dialog form").length&&a.similar.forEach(function(a){var b={};h[a]={};for(var c=
0;c<k.length;c++){for(var d=0,f=0;f<k.length;f++)k[c][a]===k[f][a]&&d++;void 0!==k[c][a]&&(b[k[c][a]]=d,h[a]=b)}var c=Object.keys(h[a]).map(function(b){return h[a][b]}),b=Math.max.apply(null,c),c=Math.min.apply(null,c),l;for(l in h[a])h[a][l]==b&&1!==b&&c!==b||$('.spec-dialog .x-spec-value span:contains("'+l+'")').addClass("x-lowest")})}}function l(){1<$(".spec-dialog form").length&&($(".spec-dialog .x-close").css("visibility","visible"),e(),$(".spec-dialog .x-close").on("click",function(a){a.preventDefault();
var b=$(a.target).next().attr("data-product-id");if(1<$(".spec-dialog form").length){$(a.target).parent().remove();if(1!=k.length)for(a=0;a<k.length;a++)k[a].id===b&&k.splice(a,1);e();c()}1===$(".spec-dialog form").length&&($(".spec-dialog .num"+$(".spec-dialog form").attr("data-product-id")).addClass("x-space"),$(".spec-dialog .x-close").css("visibility","hidden"),$(".x-item-spec").remove(),$(".spec-dialog table").append(h()),c());$(".spec-dialog").trigger("specdialogupdate")}))}a.preventDefault();
var f=$(a.target).closest(".x-product"),m=f.find(".x-wrapper-specs").html();a=f.find(".x-wrapper-image").attr("data-product-id");var n=f.find(".x-wrapper-image").attr("data-unit-name"),p=f.attr("data-item-code"),u=f.find(".x-wrapper-details").html().replace(/^[\s\S]+x-link-name/,'<a class="x-link-name').replace(/\<\/a\>[\s\S]+$/,"</a>").replace(/ title=\"[^"]+\"/,""),v=f.find(".x-wrapper-details").html().replace(/^[\s\S]+x-link-item/,'<a class="x-link-item').replace(/\<\/a\>[\s\S]+$/,"</a>"),w=f.find(".x-price").html(),
q=f.find(".x-wrapper-image img").attr("src"),x=f.find(".x-wrapper-image a").attr("href"),y=f.find(".x-wrapper-image img").prop("alt");if(m){m=""+('<th class="num'+a+'"><span class="x-close">x</span><form data-item-code="'+p+'" data-product-id="'+a+'" data-animate-element="auto" method="get" action="/order/add.html"><input type="hidden" value="'+a+'" name="item1"><input type="hidden" value="'+n+'" name="unit1"><input type="hidden" value="1" name="quantity1"><div class="x-wrapper-image item-draggable" data-unit-name="'+
n+'" data-quantity="1" data-product-id="'+a+'"><a href="'+x+'">'+(q?htmlBuild("<img/>",{"class":"x-image",alt:y,src:q,title:"Arrastrar el producto al carrito abajo"}):htmlBuild("<span/>",{"class":"x-image x-image-missing",title:"Arrastrar el producto al carrito abajo"},"No image"))+"</a></div><p autofocus>"+u+'</p><div class="x-extras"><input class="x-add rsh-button" type="submit" value="Agregar" title="Agregar al Carrito"></td><span class="x-price">'+w+"</span><span>"+v+"</span></div></form></th>");
if(0===$(".spec-dialog").length){var r="";$(f.find(".x-wrapper-specs li")).each(function(a){a=$(this).find(".x-spec-name").text();var b=$(this).find(".x-spec-value").text();r+='<tr class="x-item-spec"><th class="x-spec-name static"><div>'+a+'</div></th><th class="x-spec-value">'+b+"</th></tr>"});f='<div class="table-specs"><table><tr class="x-item-info"><th class="static"></th>'+m+"</tr>"+r+'</table></div><span class="x-footer">Haga clic en otro &nbsp;<span class="x-show-specs"></span>&nbsp; para comparar productos.<span class="ui-icon ui-icon-print x-print" title="Imprimir la comparaci\u00f3n"></span></span>';
$("<div/>").html(f).dialog({title:"Info / Comparar",modal:!1,width:"auto",maxWidth:$(window).width()-200,height:"auto",autoOpen:!0,buttonOk:!1,resizable:!0,draggable:!0,autoDestroy:!0,dialogClass:"spec-dialog",closeOnEscape:!0}).on("dialogdragstop",function(a){$(".spec-dialog").data("user-adjusted",!0)}).on("dialogclose",function(a){$("#section-to-print").remove();$(".spec-print-hidden").removeClass("printHidden spec-print-hidden")});b();$(".layout-container, .layout-container *, .ui-dialog, .ui-dialog .x-close").addClass("printHidden spec-print-hidden");
$(".x-print").on("click",function(a){a.preventDefault();window.print()});$(".spec-dialog").on("specdialogupdate",function(){$("#section-to-print").remove();$("body").append('<div id="section-to-print" class="spec-dialog-print">'+$(".spec-dialog").html()+"</div>");$("#section-to-print .ui-dialog-titlebar").html("<h3>Info/Compare</h3>").removeAttr("class");$("#section-to-print").find(".x-footer,.x-close,.x-add,.ui-resizable-handle").remove();$("#section-to-print .spec-print-hidden").removeClass("printHidden spec-print-hidden")})}if(0===
$(".num"+a).length&&($(".spec-dialog .x-item-info").append(m),b(),1<$(".spec-dialog form[data-product-id]").length)){var k=d();l()}1===$(".spec-dialog form").length&&$(".spec-dialog .num"+a).addClass("x-space");1<$(".spec-dialog form").length&&$(".spec-dialog th").removeClass("x-space");a=$(window).scrollTop();f=$(window).scrollTop()+$(window).height();m=$(".spec-dialog").offset().top;n=$(".spec-dialog").offset().top+$(".spec-dialog").height();$(".spec-dialog").data("user-adjusted")||setTimeout(function(){$(".spec-dialog").position({my:"center",
at:"center",of:window})},1);(a>n||f<m)&&setTimeout(function(){$(".spec-dialog").position({my:"center",at:"center",of:window})},1);$(window).height()<$(".spec-dialog").height()&&$(".spec-dialog").position({my:"top",at:"center",of:window});c();$(".spec-dialog").trigger("specdialogupdate");itemDraggableSetup(".spec-dialog .item-draggable")}},_expandFilters:function(a){a.preventDefault();a=this.filtersElement.find(".x-summary-facet-folded").length;this._expandFiltersDo(a?"show":"hide")},_expandFiltersDo:function(a){this.filtersElement.find(".x-summary-facet .x-facet-title").trigger("show"==
a?"filtershow":"filterhide")},_expandFilter:function(a){a.preventDefault();var b=$(a.target).closest(".x-facet-title"),c=b.closest(".x-summary-facet"),b=b.next("ul");a="filterhide"==a.type||"filtershow"==a.type?a.type:c.hasClass("x-summary-facet-folded")?"filtershow":"filterhide";"filterhide"!=a||c.hasClass("x-summary-facet-folded")||(c.addClass("x-summary-facet-folded"),this._elementHide(b));"filtershow"==a&&c.hasClass("x-summary-facet-folded")&&(c.removeClass("x-summary-facet-folded"),this._elementShow(b))},
_filterInit:function(){var a;try{a=JSON.parse(this.filtersElement.find(".x-data-summary").html())}catch(c){console.warn("Error loading browser filtering data: ",c);this._filterModel={};return}var b={};$.each(a.counts,function(c,d){var g=0,h={},e=(a.items||{})[c]||{};$.each(d,function(a,b){g+=b;h[a]={value:a,count:b,items:e[a]}});b[c]={count:g,values:h}});this._filterModel=b;this._filterSummary=a;this._multiFilter=1<$(".widget-product-search-summary").length;this._filterHashPrevious=this._filterHash=
"";this._filterCurrent={};if(this._filterBrowser)this.element.on("filterchange",$.proxy(this._onFilterChange,this));else this.element.on("filterchange",$.proxy(this._onHybridChange,this));this._multiFilter?this.element.trigger("filterchange"):$(window).on("hashchange",$.proxy(function(){this._filterHash=window.location.hash;this.element.trigger("filterchange")},this)).trigger("hashchange")},_filterClick:function(a){if(this._filterBrowser||this._filterHybrid){a.preventDefault();var b=$(a.target);if(b.closest(".x-reset").length)this._filterCurrent=
{},this._expandFiltersDo("show");else if(b.closest(".x-facet-clear").length)b=b.closest("[data-facet]").attr("data-facet"),delete this._filterCurrent[b];else if(b.closest("[data-value]").length)a=b.closest("[data-facet]").attr("data-facet"),b=b.closest("[data-value]").attr("data-value"),void 0!=a&&void 0!=b&&(this._filterCurrent[a]&&this._filterCurrent[a][b]?delete this._filterCurrent[a][b]:(this._filterCurrent[a]||(this._filterCurrent[a]={}),this._filterCurrent[a][b]=!0));else{console.warn("Unhandled click: ",
a);return}var c=this._filterCurrent||{},d="",g=1;$.each(Object.keys(c).sort(),function(a,b){$.each(Object.keys(c[b]).sort(),function(a,c){d&&(d+="&");d+="fn."+g+"="+encodeURIComponent(b)+"&";d+="fv."+g+"="+encodeURIComponent(c);++g})});d="#"+(d?d:"all=1");this._multiFilter?(this._filterHash=d,this.element.trigger("filterchange")):location.hash=d}else this._veil.fadeIn(100)},_filterDisplay:function(){var a=this._filterModel,b=this._filterCurrent,c=this;this.filtersElement.find(".x-summary-facet").each(function(){var d=
$(this),g=d.attr("data-facet"),h=a[g];if(0<h.count){c._elementShow(d);var e=0;d.find("[data-value]").each(function(){var a=$(this),d=a.attr("data-value"),m=h.values[d];0<m.count?(c._elementShow(a),a.find(".x-match-count").text(m.count),b[g]&&b[g][d]?(a.addClass("x-selected"),++e):a.removeClass("x-selected")):c._elementHide(a)});d.find(".x-facet-clear").css("visibility",0<e?"visible":"hidden")}else c._elementHide(d)})},_matchingDisplay:function(){var a=this,b=this._filterMatching;this.element.find(".x-product").each(function(c,
d){d=$(d);var g=d.attr("data-item-code");b[g]?a._elementShow(d):a._elementHide(d)});this._ItemCountDisplay(Object.keys(b).length)},_ItemCountDisplay:function(a){this.element.find(".x-item-count .x-item-count-value").text(a)},_filterFind:function(a,b){var c;if(b){var d={};$.each(a,function(a,f){a!=b&&(d[a]=f,c=!0)});a=d}void 0===c&&(c=0<Object.keys(a).length);var g={};if(c){var h=[];$.each(this._filterModel,function(b,d){var e=a[b];if(!c||e){var g={};$.each(d.values,function(a,b){c&&!e[a]||$.each(b.items,
function(a,b){g[b]=!0})});h.push(g)}});var e=h.pop();0==h.length?g=e?e:{}:$.each(e,function(a){for(var b=0,c=0;c<h.length;++c)h[c][a]&&++b;b==h.length&&(g[a]=!0)})}else this.element.find(".x-product").each(function(){var a=$(this).attr("data-item-code");a?g[a]=!0:console.warn("No item code on .x-product: ",this)});return g},_onHybridChange:function(a){var b=this;"#all=1"==this._filterHash&&(this._filterHash="");this._filterHash==this._filterHashPrevious?this.element.find(".x-content").show():(this._filterHashPrevious=
this._filterHash,this._veil.fadeIn(100),this._pcont.fadeOut(100),this.element.find(".x-item-count").fadeOut(100),a=urlParams(this._filterHash),delete a.all,this._updateFilterCurrent(a),a=$.extend({},a,{group:"product",filter_mode:"hybrid",filter_browser_max:this.element.attr("data-filter-browser-max"),keywords:this.element.attr("data-keywords"),orderby:this.element.attr("data-orderby"),pg_mode:"1"}),rshJSON("/api/search-normal.json",a,function(a){try{if("success"!=a.status)throw a.error_message||
"Unknown error";var d=a.groups[0],g=d.elements,h=d.summary;$.each(b._filterModel,function(a,b){b.count=0;var c=h.counts[a]||{};$.each(b.values,function(a,d){d.count=c[a]||0;b.count+=d.count})});var e=b.element.find(".x-buffer");0==e.length&&(b._pcont.parent().append('<div class="x-buffer" style="display: none"></div>'),e=b.element.find(".x-buffer"));b._pcont.find(".x-product").appendTo(e);var l={};e.find(".x-product").each(function(a,b){return l[$(b).attr("data-item-code")]=!0});var f=$.grep(g,function(a){return!l[a.item_code]}),
m=$.Deferred();if(f.length){var n={format:"widget-product-search",product_ids:$.map(f,function(a){return a.product_id}).join(","),display_unit_name:b.element.attr("data-display-unit-name")};rshJSON("/api/product-info.json",n,function(a){if("success"!=a.status)throw"Unable to retrieve product details";$.each(a.html,function(a,b){e.append(b)});itemDraggableSetup(e.find(".item-draggable"));m.resolve()},"POST")}else m.resolve();$.when(m).done(function(){var a=e.find(".x-product");$.each(g,function(c,
d){var e=a.filter(function(a,b){return $(b).attr("data-item-code")==d.item_code});b._pcont.append(e)});b._filterDisplay();b._ItemCountDisplay(g.length);b.element.find(".x-content").show();b._veil.fadeOut(100);b._pcont.fadeIn(100);b.element.find(".x-item-count").fadeIn(100)})}catch(p){b.element.find(".x-content").show(),b._veil.fadeOut(100),b._pcont.fadeIn(100),b.element.find(".x-item-count").fadeIn(100),console.warn("Search data error: ",p),console.log("Search data: ",a),alert("Unable to perform a search, try again or try refreshing the page")}}))},
_onFilterChange:function(a){var b=this;a=urlParams(this._filterHash);this._updateFilterCurrent(a);var c=this._filterCurrent,d=this._filterFind(c,void 0);this._filterMatching=d;$.each(this._filterModel,function(a,h){h.count=0;var e=c[a]?b._filterFind(c,a):d;$.each(h.values,function(a,b){var c=0;$.each(b.items,function(a,b){e[b]&&++c});b.count=c;h.count+=c})});this._filterDisplay();this._matchingDisplay()},_updateFilterCurrent:function(a){var b={};$.each(a,function(c,d){if("fn."==c.substring(0,3)){var g=
a["fv."+c.substring(3)];b[d]||(b[d]={});b[d][g]=!0}});this._filterCurrent=b},_elementShow:function(a){a.is(":visible")||(this.options.animate?a.slideDown(300,"linear"):a.show())},_elementHide:function(a){a.is(":hidden")||(this.options.animate?a.slideUp(300,"linear"):a.hide())}});$(function(){$(".widget-product-search").productSearch()});
//# sourceMappingURL=/js/min/widget-product-search.map
